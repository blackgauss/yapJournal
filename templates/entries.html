{% extends "layout.html" %}

{% block title %}View Transcriptions{% endblock %}

{% block content %}
    <h2>All Transcriptions</h2>

    <form method="GET" action="/entries" style="margin-bottom: 20px;">
        <label for="tagFilter">Filter by Tag:</label>
        <select id="tagFilter" name="tag">
            <option value="">-- All Tags --</option>
            <option value="miscellaneous" {% if tag_filter == "miscellaneous" %}selected{% endif %}>Miscellaneous</option>
            <option value="to-do" {% if tag_filter == "to-do" %}selected{% endif %}>To-Do</option>
            <option value="yap-dev" {% if tag_filter == "yap-dev" %}selected{% endif %}>yapDev</option>
        </select>

        <label for="searchQuery">Search:</label>
        <input type="text" id="searchQuery" name="search" value="{{ search_query }}" placeholder="Enter keywords" />

        <button type="submit">Apply</button>
    </form>

    <div id="entries-container" style="max-height: 500px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;">
        {% for entry in entries %}
        <div class="entry" style="margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #ddd;">
            <!-- Buttons Row -->
            <div class="button-row">
                <button class="btn-secondary" id="summary-btn-{{ entry.note_name }}" 
                        onclick="extractSummary('{{ entry.note_name }}', this)">Summary</button>
                <button class="btn-secondary" id="topics-btn-{{ entry.note_name }}" 
                        onclick="extractTopics('{{ entry.note_name }}', this)">Topics</button>
            </div>

            <!-- Summary and Keywords Box -->
            <div id="summary-{{ entry.note_name }}" class="summary-box" style="display: none; margin-bottom: 15px;">
                <p><strong>Summary:</strong> <span class="summary-text"></span></p>
                <p><strong>Keywords:</strong> <span class="keywords-text"></span></p>
            </div>

            <!-- Topics Box -->
            <div id="topics-{{ entry.note_name }}" class="topics-box" style="display: none; margin-bottom: 15px;">
                <p><strong>Topics:</strong></p>
            </div>

            <h3>{{ entry.note_name }}</h3>
            <p><strong>Date Created:</strong> {{ entry.date_created }}</p>
            <p><strong>Tag:</strong> {{ entry.tag }}</p>
            <p><strong>Transcription:</strong></p>
            <p>{{ entry.transcription }}</p>
        </div>
        {% else %}
        <p>No transcriptions found.</p>
        {% endfor %}
    </div>

    <style>
        .entry {
            padding: 10px;
            border-radius: 5px;
            background-color: #fafafa;
        }

        .entry p {
            word-wrap: break-word;
            white-space: pre-wrap;
            overflow-wrap: break-word;
        }

        .button-row {
            display: flex;
            justify-content: flex-start;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn-secondary {
            background-color: var(--text-color);
            color: var(--background-color);
            padding: 10px 15px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .btn-secondary:disabled {
            background-color: #ddd;
            color: #aaa;
            cursor: not-allowed;
        }

        .btn-secondary:hover {
            background-color: var(--accent-color);
            color: var(--background-color);
        }

        .summary-box, .topics-box {
            padding: 10px;
            background-color: #f0f8ff; /* Light blue for summaries and topics */
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .summary-box p, .topics-box p, .topics-box ul, .topics-list li {
            margin: 5px 0;
        }
    </style>

    <script>
        async function extractSummary(noteName, button) {
            const summaryDiv = document.getElementById(`summary-${noteName}`);
            const summaryText = summaryDiv.querySelector(".summary-text");
            const keywordsText = summaryDiv.querySelector(".keywords-text");

            summaryDiv.style.display = 'block';
            summaryDiv.innerHTML = "<p>Loading summary...</p>";
            button.disabled = true;

            try {
                const response = await fetch('/summarize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ note_name: noteName }),
                });

                if (response.ok) {
                    const data = await response.json();
                    summaryDiv.innerHTML = `
                        <p><strong>Summary:</strong> ${data.summary}</p>
                        <p><strong>Keywords:</strong> ${data.keywords.join(', ')}</p>`;
                } else {
                    summaryDiv.innerHTML = "<p>Error extracting summary. Please try again.</p>";
                }
            } catch (error) {
                console.error('Error in extractSummary:', error);
                summaryDiv.innerHTML = "<p>An unexpected error occurred.</p>";
            } finally {
                button.disabled = false;
            }
        }

        async function extractTopics(noteName, button) {
    const topicsDiv = document.getElementById(`topics-${noteName}`);
    topicsDiv.innerHTML = "<p>Loading topics...</p>";
    button.disabled = true;

    try {
        const response = await fetch('/topics', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ note_name: noteName }),
        });

        if (response.ok) {
            const data = await response.json();
            console.log("Topics Response:", data); // Debug log

            // Clear the topicsDiv and ensure it's ready for rendering
            topicsDiv.innerHTML = "<p><strong>Topics:</strong></p>";

            // Check if the response contains any data
            if (Object.keys(data).length === 0) {
                topicsDiv.innerHTML += "<p>No topics could be extracted from this text.</p>";
                return;
            }

            // Create a <ul> element for topics
            const ul = document.createElement("ul");
            ul.className = "topics-list";
            topicsDiv.appendChild(ul);

            for (const [broadTopic, details] of Object.entries(data)) {
                // Handle cases where subtopics are missing
                if (!details.subtopics || details.subtopics.length === 0) {
                    const broadLi = document.createElement("li");
                    broadLi.textContent = `${broadTopic} (No subtopics found)`;
                    ul.appendChild(broadLi);
                    continue;
                }

                const broadScore = details.broad_score.toFixed(2);

                // Add broad topic
                const broadLi = document.createElement("li");
                broadLi.innerHTML = `<strong>${broadTopic}</strong> (Score: ${broadScore})`;
                ul.appendChild(broadLi);

                // Add subtopics
                details.subtopics.forEach(([subtopic, score]) => {
                    const subtopicLi = document.createElement("li");
                    subtopicLi.style.marginLeft = "20px";
                    subtopicLi.textContent = `${subtopic} (Score: ${score.toFixed(2)})`;
                    ul.appendChild(subtopicLi);
                });
            }
        } else {
            topicsDiv.innerHTML = "<p>Error extracting topics. Please try again.</p>";
        }
    } catch (error) {
        console.error("Error in extractTopics:", error);
        topicsDiv.innerHTML = "<p>An unexpected error occurred.</p>";
    } finally {
        button.disabled = false;
    }
}

    </script>
{% endblock %}
