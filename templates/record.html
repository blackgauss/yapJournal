{% extends "layout.html" %}

{% block title %}Record Audio{% endblock %}

{% block content %}
    <h2>Record Audio</h2>
    <p>Enter a name for your recording:</p>
    <input type="text" id="noteName" placeholder="Enter note name" />
    <p>Click the button below to start recording audio.</p>
    <button id="startRecording">Start Recording</button>
    <button id="stopRecording" disabled>Stop Recording</button>
    <button id="uploadRecording" disabled>Upload Recording</button>
    <button id="transcribeRecording" disabled>Transcribe Recording</button>
    <p id="status">Status: Not Recording</p>

    <h3>Recorded Audio</h3>
    <audio id="audioPlayback" controls></audio>

    <h3>Transcription Result</h3>
    <pre id="transcriptionResult"></pre>

    <script>
        // Select buttons and UI elements
        const startButton = document.getElementById("startRecording");
        const stopButton = document.getElementById("stopRecording");
        const uploadButton = document.getElementById("uploadRecording");
        const transcribeButton = document.getElementById("transcribeRecording");
        const noteNameInput = document.getElementById("noteName");
        const statusText = document.getElementById("status");
        const audioPlayback = document.getElementById("audioPlayback");
        const transcriptionResult = document.getElementById("transcriptionResult");

        // MediaRecorder variables
        let mediaRecorder;
        let audioChunks = [];
        let uploadedFileName = null;

        // Start Recording
        startButton.addEventListener("click", async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);

                // Update UI
                statusText.textContent = "Status: Recording...";
                startButton.disabled = true;
                stopButton.disabled = false;

                // Capture audio chunks
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                // Handle stop recording
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    audioPlayback.src = audioUrl;

                    // Reset UI
                    statusText.textContent = "Status: Not Recording";
                    startButton.disabled = false;
                    stopButton.disabled = true;
                    uploadButton.disabled = false; // Enable upload button
                };

                // Start recording
                audioChunks = [];
                mediaRecorder.start();
            } catch (error) {
                console.error("Error accessing microphone:", error);
                alert("Could not access microphone. Please check permissions.");
            }
        });

        // Stop Recording
        stopButton.addEventListener("click", () => {
            if (mediaRecorder && mediaRecorder.state !== "inactive") {
                mediaRecorder.stop();
            }
        });

        // Upload Recording
        uploadButton.addEventListener("click", () => {
            if (!audioChunks.length) {
                alert("No recording to upload!");
                return;
            }

            // Get the note name from the input field
            const noteName = noteNameInput.value.trim();
            if (!noteName) {
                alert("Please enter a note name before uploading!");
                return;
            }

            // Create a Blob from audio chunks
            const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
            const formData = new FormData();
            formData.append("audio", audioBlob);
            formData.append("note_name", noteName); // Add the note name to the form data

            // Upload the audio file to the server
            fetch("/upload_audio", {
                method: "POST",
                body: formData,
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.file_path) {
                        statusText.textContent = "Status: Upload successful!";
                        uploadedFileName = data.file_path; // Save the file path for transcription
                        transcribeButton.disabled = false; // Enable transcribe button
                    } else {
                        statusText.textContent = "Status: Upload failed!";
                    }
                })
                .catch((error) => {
                    console.error("Error uploading audio:", error);
                    statusText.textContent = "Status: Upload failed!";
                });
        });

        // Transcribe Recording
        transcribeButton.addEventListener("click", () => {
            if (!uploadedFileName) {
                alert("No uploaded file to transcribe!");
                return;
            }

            // Send a POST request to the /transcribe endpoint
            fetch("/transcribe", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ file_path: uploadedFileName }),
            })
                .then((response) => response.json())
                .then((data) => {
                    if (data.transcription) {
                        transcriptionResult.textContent = data.transcription;
                        statusText.textContent = "Status: Transcription successful!";
                    } else {
                        statusText.textContent = "Status: Transcription failed!";
                    }
                })
                .catch((error) => {
                    console.error("Error during transcription:", error);
                    statusText.textContent = "Status: Transcription failed!";
                });
        });
    </script>
{% endblock %}
